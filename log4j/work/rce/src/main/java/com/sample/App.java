package com.sample;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.util.Collections;
import java.util.Scanner;

import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class App {

    private static final Logger logger = LogManager.getLogger();

    public static void main(String[] args) throws IOException {
        System.setProperty("com.sun.jndi.ldap.object.trustURLCodebase", "true");
        int port = 8081;
        HttpServer server = HttpServer.create(new InetSocketAddress(port), 0);
        server.createContext("/", new IndexHandler());
        logger.info("Server started: Listening on port " + port);
        server.start();
    }

    private static class IndexHandler implements HttpHandler {
        public void handle(HttpExchange t) throws IOException {
            String responseBody = ""
                    + "<form action='/' method='POST'>\n"
                    + "<input type='text' name='username' placeholder='Your name'/>\n"
                    + "<input type='submit' value='SUBMIT'/>"
                    + "</form>\n";
            if (t.getRequestMethod().equals("POST")) {
                InputStream in = t.getRequestBody();
                Scanner scanner = new Scanner(in);
                String params = new String(scanner.next());
                int index = params.indexOf("=");
                String encodedUsernae = params.substring(index + 1);
                String username = URLDecoder.decode(encodedUsernae, StandardCharsets.UTF_8);
                responseBody += "<h1>Hello " + username + "</h1>";
                logger.info("User Name: " + username);
                scanner.close();
            }

            long contentLength = responseBody.getBytes(StandardCharsets.UTF_8).length;
            t.getResponseHeaders().put("Content-Type", Collections.singletonList("text/html"));
            t.sendResponseHeaders(200, contentLength);
            OutputStream out = t.getResponseBody();
            out.write(responseBody.getBytes());
            out.close();
        }
    }
}
